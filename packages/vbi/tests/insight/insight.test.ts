import { quickInsight } from '@visactor/vbi'

test('quickInsight zScoreMad 基本计算', () => {
  const dataset = [
    {
      'Sum(sales)': 452108.2440000001,
      'Sum(profit)': -131728.99600000013,
      区域: '华东',
      省份: '浙江',
    },
    {
      'Sum(sales)': 400877.5960000003,
      'Sum(profit)': -89487.52399999995,
      区域: '西南',
      省份: '四川',
    },
    {
      'Sum(sales)': 649967.2200000006,
      'Sum(profit)': -107603.02000000003,
      区域: '华东',
      省份: '江苏',
    },
    {
      'Sum(sales)': 1452929.5129999993,
      'Sum(profit)': 337994.9929999998,
      区域: '中南',
      省份: '广东',
    },
    {
      'Sum(sales)': 237328.70000000013,
      'Sum(profit)': 47807.06000000001,
      区域: '华东',
      省份: '江西',
    },
    {
      'Sum(sales)': 457688.16800000006,
      'Sum(profit)': 105814.68799999998,
      区域: '西北',
      省份: '陕西',
    },
    {
      'Sum(sales)': 1178801.1620000016,
      'Sum(profit)': 257172.06199999977,
      区域: '东北',
      省份: '黑龙江',
    },
    {
      'Sum(sales)': 1586782.9879999978,
      'Sum(profit)': 385463.008,
      区域: '华东',
      省份: '山东',
    },
    {
      'Sum(sales)': 582450.5679999999,
      'Sum(profit)': 121650.088,
      区域: '华东',
      省份: '上海',
    },
    {
      'Sum(sales)': 790915.405,
      'Sum(profit)': 172031.6850000001,
      区域: '华北',
      省份: '河北',
    },
    {
      'Sum(sales)': 546903.5320000001,
      'Sum(profit)': 142601.73200000002,
      区域: '华东',
      省份: '福建',
    },
    {
      'Sum(sales)': 628965.1899999997,
      'Sum(profit)': 149028.81000000008,
      区域: '华东',
      省份: '安徽',
    },
    {
      'Sum(sales)': 179270.02800000008,
      'Sum(profit)': -42682.192,
      区域: '西北',
      省份: '甘肃',
    },
    {
      'Sum(sales)': 640196.5709999998,
      'Sum(profit)': 153058.17100000003,
      区域: '东北',
      省份: '吉林',
    },
    {
      'Sum(sales)': 862569.7359999995,
      'Sum(profit)': -168038.7240000001,
      区域: '东北',
      省份: '辽宁',
    },
    {
      'Sum(sales)': 621960.3320000009,
      'Sum(profit)': -132032.34800000003,
      区域: '中南',
      省份: '湖北',
    },
    {
      'Sum(sales)': 853574.798999999,
      'Sum(profit)': 199528.67900000006,
      区域: '中南',
      省份: '河南',
    },
    {
      'Sum(sales)': 723442.2090000004,
      'Sum(profit)': 156735.92899999995,
      区域: '中南',
      省份: '湖南',
    },
    {
      'Sum(sales)': 409147.2,
      'Sum(profit)': 91961.94000000003,
      区域: '华北',
      省份: '北京',
    },
    {
      'Sum(sales)': 361761.9320000001,
      'Sum(profit)': 64431.752000000066,
      区域: '西南',
      省份: '重庆',
    },
    {
      'Sum(sales)': 49863.38,
      'Sum(profit)': 12277.299999999997,
      区域: '西北',
      省份: '青海',
    },
    {
      'Sum(sales)': 377653.82899999997,
      'Sum(profit)': 84724.26900000003,
      区域: '中南',
      省份: '广西',
    },
    {
      'Sum(sales)': 549906.6300000001,
      'Sum(profit)': 117704.08999999998,
      区域: '华北',
      省份: '天津',
    },
    {
      'Sum(sales)': 360925.76800000016,
      'Sum(profit)': 86639.16800000003,
      区域: '西南',
      省份: '云南',
    },
    {
      'Sum(sales)': 61402.431999999986,
      'Sum(profit)': 15788.332,
      区域: '西南',
      省份: '海南',
    },
    {
      'Sum(sales)': 108141.59999999999,
      'Sum(profit)': 18998.420000000006,
      区域: '西南',
      省份: '贵州',
    },
    {
      'Sum(sales)': 423878.76999999967,
      'Sum(profit)': 107063.39000000009,
      区域: '华北',
      省份: '山西',
    },
    {
      'Sum(sales)': 273453.01199999993,
      'Sum(profit)': -57707.88800000001,
      区域: '华北',
      省份: '内蒙古',
    },
    {
      'Sum(sales)': 58121,
      'Sum(profit)': 8537.62,
      区域: '西北',
      省份: '宁夏',
    },
    {
      'Sum(sales)': 107854.41100000001,
      'Sum(profit)': 23933.790999999994,
      区域: '中南',
      省份: '海南',
    },
    {
      'Sum(sales)': 70097.02,
      'Sum(profit)': 14606.059999999998,
      区域: '西北',
      省份: '新疆',
    },
    {
      'Sum(sales)': 10015.18,
      'Sum(profit)': 1266.5800000000002,
      区域: '西南',
      省份: '西藏自治区',
    },
  ]
  const result = quickInsight(dataset, { insightType: 'zScoreMad', measures: ['Sum(sales)', 'Sum(profit)'] })
  expect(result).toMatchInlineSnapshot(`
    {
      "dataset": [
        {
          "Sum(profit)": -131728.99600000013,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -1.9691361124973374,
          "Sum(sales)": 452108.2440000001,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.04597259255074149,
          "区域": "华东",
          "省份": "浙江",
        },
        {
          "Sum(profit)": -89487.52399999995,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -1.5659544204579763,
          "Sum(sales)": 400877.5960000003,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -0.1208888733493605,
          "区域": "西南",
          "省份": "四川",
        },
        {
          "Sum(profit)": -107603.02000000003,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -1.738861186808644,
          "Sum(sales)": 649967.2200000006,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.6904118113725157,
          "区域": "华东",
          "省份": "江苏",
        },
        {
          "Sum(profit)": 337994.9929999998,
          "Sum(profit)_isAnomaly": true,
          "Sum(profit)_score": 2.514233043683992,
          "Sum(sales)": 1452929.5129999993,
          "Sum(sales)_isAnomaly": true,
          "Sum(sales)_score": 3.3057108658074217,
          "区域": "中南",
          "省份": "广东",
        },
        {
          "Sum(profit)": 47807.06000000001,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -0.2555203833827557,
          "Sum(sales)": 237328.70000000013,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -0.6535779881328287,
          "区域": "华东",
          "省份": "江西",
        },
        {
          "Sum(profit)": 105814.68799999998,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.2981443565256852,
          "Sum(sales)": 457688.16800000006,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.06414675849631286,
          "区域": "西北",
          "省份": "陕西",
        },
        {
          "Sum(profit)": 257172.06199999977,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 1.742803343597774,
          "Sum(sales)": 1178801.1620000016,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 2.4128574610908253,
          "区域": "东北",
          "省份": "黑龙江",
        },
        {
          "Sum(profit)": 385463.008,
          "Sum(profit)_isAnomaly": true,
          "Sum(profit)_score": 2.967300460592422,
          "Sum(sales)": 1586782.9879999978,
          "Sum(sales)_isAnomaly": true,
          "Sum(sales)_score": 3.7416801132454482,
          "区域": "华东",
          "省份": "山东",
        },
        {
          "Sum(profit)": 121650.088,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.44928831680529085,
          "Sum(sales)": 582450.5679999999,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.4705057987570358,
          "区域": "华东",
          "省份": "上海",
        },
        {
          "Sum(profit)": 172031.6850000001,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.9301649663241605,
          "Sum(sales)": 790915.405,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 1.1494889787169298,
          "区域": "华北",
          "省份": "河北",
        },
        {
          "Sum(profit)": 142601.73200000002,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.6492652323570569,
          "Sum(sales)": 546903.5320000001,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.35472685066792176,
          "区域": "华东",
          "省份": "福建",
        },
        {
          "Sum(profit)": 149028.81000000008,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.7106096898349821,
          "Sum(sales)": 628965.1899999997,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.6220068692238614,
          "区域": "华东",
          "省份": "安徽",
        },
        {
          "Sum(profit)": -42682.192,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -1.1192121063590752,
          "Sum(sales)": 179270.02800000008,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -0.8426787607432641,
          "区域": "西北",
          "省份": "甘肃",
        },
        {
          "Sum(profit)": 153058.17100000003,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.7490686854357363,
          "Sum(sales)": 640196.5709999998,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.6585881886274841,
          "区域": "东北",
          "省份": "吉林",
        },
        {
          "Sum(profit)": -168038.7240000001,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -2.3157011557924396,
          "Sum(sales)": 862569.7359999995,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 1.3828716739494995,
          "区域": "东北",
          "省份": "辽宁",
        },
        {
          "Sum(profit)": -132032.34800000003,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -1.9720315128433166,
          "Sum(sales)": 621960.3320000009,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.5991916029734352,
          "区域": "中南",
          "省份": "湖北",
        },
        {
          "Sum(profit)": 199528.67900000006,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 1.1926152087521724,
          "Sum(sales)": 853574.798999999,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 1.3535745943283488,
          "区域": "中南",
          "省份": "河南",
        },
        {
          "Sum(profit)": 156735.92899999995,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.7841717399256758,
          "Sum(sales)": 723442.2090000004,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.9297245050463081,
          "区域": "中南",
          "省份": "湖南",
        },
        {
          "Sum(profit)": 91961.94000000003,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.16592419199082176,
          "Sum(sales)": 409147.2,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -0.09395424925767809,
          "区域": "华北",
          "省份": "北京",
        },
        {
          "Sum(profit)": 64431.752000000066,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -0.09684287682727348,
          "Sum(sales)": 361761.9320000001,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -0.24829106890027192,
          "区域": "西南",
          "省份": "重庆",
        },
        {
          "Sum(profit)": 12277.299999999997,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -0.5946408750775608,
          "Sum(sales)": 49863.38,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -1.2641644109442647,
          "区域": "西北",
          "省份": "青海",
        },
        {
          "Sum(profit)": 84724.26900000003,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.09684287682727348,
          "Sum(sales)": 377653.82899999997,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -0.19653015364982607,
          "区域": "中南",
          "省份": "广西",
        },
        {
          "Sum(profit)": 117704.08999999998,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.41162499507199674,
          "Sum(sales)": 549906.6300000001,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": 0.3645081310944677,
          "区域": "华北",
          "省份": "天津",
        },
        {
          "Sum(profit)": 86639.16800000003,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.11511999129204589,
          "Sum(sales)": 360925.76800000016,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -0.25101450801767056,
          "区域": "西南",
          "省份": "云南",
        },
        {
          "Sum(profit)": 15788.332,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -0.561129168322542,
          "Sum(sales)": 61402.431999999986,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -1.2265809876032696,
          "区域": "西南",
          "省份": "海南",
        },
        {
          "Sum(profit)": 18998.420000000006,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -0.5304898783035946,
          "Sum(sales)": 108141.59999999999,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -1.0743485565898814,
          "区域": "西南",
          "省份": "贵州",
        },
        {
          "Sum(profit)": 107063.39000000009,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": 0.310062828145542,
          "Sum(sales)": 423878.76999999967,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -0.0459725925507413,
          "区域": "华北",
          "省份": "山西",
        },
        {
          "Sum(profit)": -57707.88800000001,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -1.2626276941811339,
          "Sum(sales)": 273453.01199999993,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -0.535918815542378,
          "区域": "华北",
          "省份": "内蒙古",
        },
        {
          "Sum(profit)": 8537.62,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -0.6303349557688244,
          "Sum(sales)": 58121,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -1.2372688194997448,
          "区域": "西北",
          "省份": "宁夏",
        },
        {
          "Sum(profit)": 23933.790999999994,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -0.4833832994745714,
          "Sum(sales)": 107854.41100000001,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -1.0752839493557582,
          "区域": "中南",
          "省份": "海南",
        },
        {
          "Sum(profit)": 14606.059999999998,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -0.5724135862853147,
          "Sum(sales)": 70097.02,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -1.198262163701658,
          "区域": "西北",
          "省份": "新疆",
        },
        {
          "Sum(profit)": 1266.5800000000002,
          "Sum(profit)_isAnomaly": false,
          "Sum(profit)_score": -0.6997347676429432,
          "Sum(sales)": 10015.18,
          "Sum(sales)_isAnomaly": false,
          "Sum(sales)_score": -1.3939525226519376,
          "区域": "西南",
          "省份": "西藏自治区",
        },
      ],
      "insightInfo": [
        {
          "algorithm": "zScoreMad",
          "field": "Sum(sales)",
          "isAnomalyField": "Sum(sales)_isAnomaly",
          "params": {
            "mad": 207088.3885000003,
            "median": 437993.50699999987,
            "threshold": 2.5,
          },
          "scoreField": "Sum(sales)_score",
        },
        {
          "algorithm": "zScoreMad",
          "field": "Sum(profit)",
          "isAnomalyField": "Sum(profit)_isAnomaly",
          "params": {
            "mad": 70667.576,
            "median": 74578.01050000005,
            "threshold": 2.5,
          },
          "scoreField": "Sum(profit)_score",
        },
      ],
    }
  `)
})
