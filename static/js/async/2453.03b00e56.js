"use strict";(self.rspackChunkwebsite=self.rspackChunkwebsite||[]).push([["2453"],{60059(e,t,a){a.r(t),a.d(t,{ChartTypeBuilder:()=>m,findTreeNodesBy:()=>b.O,VBI:()=>w,DimensionsBuilder:()=>i,MeasuresBuilder:()=>o,VBIBuilder:()=>g,quickInsight:()=>S,preorderTraverse:()=>b.a,buildVQuery:()=>c});var s=a(73793);class r{yMap;constructor(e){this.yMap=e}setAlias(e){return this.yMap.set("alias",e),this}build(){return this.yMap.toJSON()}}class i{dsl;doc;constructor(e,t){this.doc=e,this.dsl=t}addDimension(e,t){let a={};"string"==typeof e?(a.alias=e,a.field=e):(a.alias=e.alias,a.field=e.field||e.alias);let i=new s.Map;for(let[e,t]of Object.entries(a))i.set(e,t);this.dsl.get("dimensions").push([i]);let n=new r(i);return t?(t(n),this):n}removeDimension(e){let t=this.dsl.get("dimensions").toArray().findIndex(t=>t.get("field")===e);-1!==t&&this.dsl.get("dimensions").delete(t,1)}getDimensions(){return this.dsl.get("dimensions").toJSON()}observe(e){this.dsl.get("dimensions").observe(e)}unobserve(e){this.dsl.get("dimensions").unobserve(e)}static isDimensionNode(e){return"alias"in e&&!("children"in e)}static isDimensionGroup(e){return"children"in e}}class n{yMap;constructor(e){this.yMap=e}setAlias(e){return this.yMap.set("alias",e),this}setEncoding(e){return this.yMap.set("encoding",e),this}setAggregate(e){return this.yMap.set("aggregate",e),this}build(){return this.yMap.toJSON()}}class o{dsl;doc;constructor(e,t){this.doc=e,this.dsl=t}addMeasure(e,t){let a={};"string"==typeof e?(a.alias=e,a.field=e,a.encoding="yAxis",a.aggregate={func:"sum"}):(a.alias=e.alias,a.field=e.field,a.encoding=e.encoding,a.aggregate=e.aggregate);let r=new s.Map;for(let[e,t]of Object.entries(a))r.set(e,t);this.dsl.get("measures").push([r]);let i=new n(r);return t?(t(i),this):i}removeMeasure(e){let t=this.dsl.get("measures").toArray().findIndex(t=>t.get("field")===e);-1!==t&&this.dsl.get("measures").delete(t,1)}getMeasures(){return this.dsl.get("measures").toJSON()}observe(e){this.dsl.get("measures").observe(e)}unobserve(e){this.dsl.get("measures").unobserve(e)}static isMeasureNode(e){return"field"in e}static isMeasureGroup(e){return"children"in e}}var l=a(23821);let c=(e,t)=>{let a=a=>s=>a(s,{vbiDSL:e,builder:t});return(0,l.a)({},a(d),a(u),a(h))},d=(e,t)=>{let{vbiDSL:a}=t,s=a.measures,r=a.dimensions,n={...e},l=s.filter(e=>o.isMeasureNode(e)).map(e=>({field:e.field,alias:e.alias,func:e.aggregate.func})),c=r.filter(e=>i.isDimensionNode(e)).map(e=>({field:e.field,alias:e.alias}));return n.select=l.concat(c),n},u=(e,t)=>{let a={...e},{vbiDSL:s}=t;return a.groupBy=s.dimensions.filter(e=>i.isDimensionNode(e)).map(e=>e.field),a},h=e=>{let t={...e};return t.limit=1e3,t};var p=a(83684);class m{dsl;constructor(e,t){this.dsl=t}observe(e){this.dsl.observe((t,a)=>{t.keysChanged.has("chartType")&&e(t,a)})}unobserve(e){this.dsl.unobserve((t,a)=>{t.keysChanged.has("chartType")&&e(t,a)})}changeChartType(e){this.dsl.set("chartType",e)}getChartType(){return this.dsl.get("chartType")||"table"}getAvailableChartTypes(){return[p.k2.Table,p.k2.PivotTable,p.k2.Line,p.k2.Column,p.k2.ColumnPercent,p.k2.ColumnParallel,p.k2.BarPercent,p.k2.BarParallel,p.k2.Area,p.k2.AreaPercent,p.k2.DualAxis,p.k2.Scatter,p.k2.Rose,p.k2.RoseParallel,p.k2.Pie,p.k2.Donut,p.k2.Radar,p.k2.Funnel,p.k2.Heatmap,p.k2.Boxplot,p.k2.Histogram]}}let y=new Map,f=async e=>{let t=y.get(e);if(!t)throw Error(`connector ${e} not registered`);return"function"==typeof t?t():t};class g{doc;dsl;undoManager;chartType;measures;dimensions;constructor(e){this.doc=e,this.dsl=e.getMap("dsl"),this.undoManager=new s.UndoManager(this.dsl),this.chartType=new m(e,this.dsl),this.measures=new o(e,this.dsl),this.dimensions=new i(e,this.dsl)}applyUpdate(e){s.applyUpdate(this.doc,e)}encodeStateAsUpdate(e){return s.encodeStateAsUpdate(this.doc,e)}buildVSeed=async()=>{let e=this.build(),t=e.connectorId,a=await f(e.connectorId),s=this.buildVQuery(),r=await a.discoverSchema(),i=await a.query({queryDSL:s,schema:r,connectorId:t});return{chartType:e.chartType,dataset:i.dataset}};buildVQuery=()=>c(this.build(),this);build=()=>this.dsl.toJSON();getSchema=async()=>{let e=this.dsl.get("connectorId"),t=await f(e);return await t.discoverSchema()}}let w={connectorMap:y,registerConnector:(e,t)=>{y.set(e,t)},getConnector:f,generateEmptyDSL:e=>({connectorId:e,chartType:"table",measures:[],dimensions:[],theme:"light",locale:"zh-CN",version:0}),from:e=>{let t=new s.Doc,a=t.getMap("dsl");return t.transact(()=>{e.connectorId&&a.set("connectorId",e.connectorId),e.chartType&&a.set("chartType",e.chartType),e.theme&&a.set("theme",e.theme),e.locale&&a.set("locale",e.locale),e.version&&a.set("version",e.version),a.get("measures")?a.set("measures",e.measures):a.set("measures",new s.Array),a.get("dimensions")?a.set("dimensions",e.dimensions):a.set("dimensions",new s.Array)}),new g(t)}};var b=a(42437),A=a(8542);let v={zScoreMad:(e,t)=>{if("zScoreMad"!==t.insightType)return{dataset:e,insightInfo:[]};let{measures:a,threshold:s=2.5}=t,r={};for(let t of a){let a=e.map(e=>e[t]).filter(e=>"number"==typeof e&&Number.isFinite(e)),s=a.length?(0,A.JZ)(a):0,i=a.length?(0,A.hK)(a):0;r[t]={median:s,mad:i}}return{dataset:e.map(e=>{let t={...e};for(let i of a){let a=e[i],n=`${i}_score`,o=`${i}_isAnomaly`,l=0;if("number"==typeof a&&Number.isFinite(a)){let e=r[i].median,t=r[i].mad;l=0===t?0:.6745*(a-e)/t}t[n]=l,t[o]=Math.abs(l)>=s}return t}),insightInfo:a.map(e=>({field:e,scoreField:`${e}_score`,isAnomalyField:`${e}_isAnomaly`,algorithm:"zScoreMad",params:{threshold:s,median:r[e]?.median??0,mad:r[e]?.mad??0}}))}},zScoreRolling:(e,t)=>{if("zScoreRolling"!==t.insightType)return{dataset:e,insightInfo:[]};let{valueField:a,window:s,outputField:r,timeField:i,threshold:n}=t.schema,o=r??a;return{dataset:e.map((t,r)=>{let i={...t},l=[],c=Math.max(0,r-s);for(let t=c;t<r;t++){let s=e[t][a];"number"==typeof s&&Number.isFinite(s)&&l.push(s)}let d=t[a],u=0;if("number"==typeof d&&Number.isFinite(d)&&l.length>=2){let e=(0,A.RE)(l),t=(0,A.Fx)(l);u=0===t?0:(d-e)/t}return i[`${o}_score`]=u,i[`${o}_isAnomaly`]=Math.abs(u)>=n,i}),insightInfo:[{field:o,scoreField:`${o}_score`,isAnomalyField:`${o}_isAnomaly`,algorithm:"zScoreRolling",params:{window:s,threshold:n,valueField:a,outputField:o,timeField:i??null}}]}}};function S(e,t){let a=v[t.insightType];return a?a(e,t):{dataset:e,insightInfo:[]}}},24558(e,t,a){a.r(t),a.d(t,{isUrl:()=>u,convertDSLToSQL:()=>d,isBase64Url:()=>p,isHttpUrl:()=>h,DatasetSourceBuilder:()=>m,VQuery:()=>b});var s=a(91707),r=a(42653),i=a(58274),n=a(33482);class o{createDriver(){return new r.t}createQueryCompiler(){return new i.l}createAdapter(){return new n.j}createIntrospector(e){return new class{async getSchemas(){return[]}async getTables(e){return e?.withInternalKyselyTables,[]}async getMetadata(e){return e?.withInternalKyselyTables,{tables:[]}}}}}let l=e=>null===e?"null":"string"==typeof e?`'${e.replace(/'/g,"''")}'`:"number"==typeof e?`${e}`:"boolean"==typeof e?e?"TRUE":"FALSE":`'${String(e).replace(/'/g,"''")}'`;var c=a(49177);let d=(e,t)=>{var a,r,i;let n,d=new s._$({dialect:new o}).selectFrom(t);if(d=e.select&&e.select.length>0?d.select(t=>e.select.map(e=>{if("object"==typeof e&&"field"in e){let a=e.field;if(e.func){let s=e.alias??a;switch(e.func){case"avg":return t.fn.avg(a).as(s);case"sum":return t.fn.sum(a).as(s);case"min":return t.fn.min(a).as(s);case"max":return t.fn.max(a).as(s);case"count":return t.fn.count(a).as(s)}}return e.alias?t.ref(a).as(e.alias):a}return e})):d.selectAll(),e.where&&(d=d.where((a=e.where,(n=e=>{if("op"in e&&"conditions"in e){let t=e.conditions.map(e=>n(e)),a=(0,c.l)` ${c.l.raw(e.op)} `;return(0,c.l)`(${c.l.join(t,a)})`}let t=e.field,a=e.value;switch(e.op){case"is null":return(0,c.l)`${c.l.ref(t)} is null`;case"is not null":return(0,c.l)`${c.l.ref(t)} is not null`;case"in":{let e=Array.isArray(a)?a:[a];return(0,c.l)`${c.l.ref(t)} in (${c.l.join(e.map(e=>c.l.val(e)))})`}case"not in":{let e=Array.isArray(a)?a:[a];return(0,c.l)`not ${c.l.ref(t)} in (${c.l.join(e.map(e=>c.l.val(e)))})`}case"between":{let[e,s]=a;return(0,c.l)`${c.l.ref(t)} between (${c.l.val(e)}, ${c.l.val(s)})`}case"not between":{let[e,s]=a;return(0,c.l)`not ${c.l.ref(t)} between (${c.l.val(e)}, ${c.l.val(s)})`}default:return(0,c.l)`${c.l.ref(t)} ${c.l.raw(e.op)} ${c.l.val(a)}`}})(a)))),d=((e,t)=>{if(t&&t.length>0){let a=t.map(e=>c.l.id(e));e=e.groupBy(a)}return e})(d,e.groupBy),e.orderBy&&e.orderBy.length>0)for(let t of e.orderBy)d=d.orderBy(t.field,t.order??"asc");r=d,(i=e.limit)&&"number"==typeof i&&(r=r.limit(i));let u=(d=r).compile();return((e,t)=>{if(0===t.length)return e;if(e.includes("?")){let a=e;for(let e of t)a=a.replace(/\?/,l(e));return a}return/\$\d+/.test(e)?e.replace(/\$(\d+)/g,(e,a)=>l(t[Number(a)-1])):e})(u.sql,u.parameters)},u=e=>h(e)||p(e),h=e=>e.startsWith("http://")||e.startsWith("https://"),p=e=>e.startsWith("data:");class m{type;value;constructor(e){this.type=e.type,this.value=e.rawDataset}static from(e){return new m(e)}async build(){let e=await m.convertToBlob(this.type,this.value);return{type:this.type,blob:e}}static async convertToBlob(e,t){if(t instanceof Blob)return t;switch(e){case"csv":return t instanceof ArrayBuffer?new Blob([t],{type:"text/csv"}):"string"==typeof t&&u(t)?m.fetchBlob(t):new Blob([JSON.stringify(t)],{type:"text/csv"});case"json":return t instanceof ArrayBuffer?new Blob([t],{type:"application/json"}):"string"==typeof t&&u(t)?m.fetchBlob(t):new Blob([JSON.stringify(t)],{type:"application/json"});case"xlsx":return t instanceof ArrayBuffer?new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}):"string"==typeof t&&u(t)?m.fetchBlob(t):new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});case"parquet":return t instanceof ArrayBuffer?new Blob([t],{type:"application/parquet"}):"string"==typeof t&&u(t)?m.fetchBlob(t):new Blob([t],{type:"application/parquet"});default:return new Blob([t])}}static async fetchBlob(e){let t=await fetch(e);return await t.blob()}}class y{db=null;dbName;datasetStoreName="vqueryDatasets";constructor(e="vquery"){this.dbName=e}open=()=>new Promise((e,t)=>{let a=indexedDB.open(this.dbName,2);a.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(this.datasetStoreName)||t.createObjectStore(this.datasetStoreName,{keyPath:"datasetId"})},a.onsuccess=t=>{this.db=t.target.result,e()},a.onerror=e=>{t(e.target.error)}});close=async()=>{this.db&&(this.db.close(),this.db=null)};writeDataset=(e,t,a)=>new Promise((s,r)=>{if(!this.db)return r("DB is not open");let i=this.db.transaction([this.datasetStoreName],"readwrite").objectStore(this.datasetStoreName).put({datasetId:e,datasetSchema:t,datasetSource:a});i.onsuccess=()=>{s()},i.onerror=e=>{r(e.target.error)}});readDataset=e=>new Promise((t,a)=>{if(!this.db)return a("DB is not open");let s=this.db.transaction([this.datasetStoreName],"readonly").objectStore(this.datasetStoreName).get(e);s.onsuccess=e=>{t(e.target.result||null)},s.onerror=e=>{a(e.target.error)}});deleteDataset=e=>new Promise((t,a)=>{if(!this.db)return a("DB is not open");let s=this.db.transaction([this.datasetStoreName],"readwrite").objectStore(this.datasetStoreName).delete(e);s.onsuccess=()=>{t()},s.onerror=e=>{a(e.target.error)}});listDatasets=()=>new Promise((e,t)=>{if(!this.db)return t("DB is not open");let a=this.db.transaction([this.datasetStoreName],"readonly").objectStore(this.datasetStoreName).getAll();a.onsuccess=t=>{e(t.target.result)},a.onerror=e=>{t(e.target.error)}})}var f=a(61642);class g{db=null;connection=null;open=async()=>{let e={mvp:{mainModule:new URL(a(89950),a.b).href,mainWorker:new URL(a(68728),a.b).toString()},eh:{mainModule:new URL(a(15852),a.b).href,mainWorker:new URL(a(63716),a.b).toString()}},t=await (0,f.DF)(e),s=URL.createObjectURL(new Blob([`importScripts("${t.mainWorker}");`],{type:"text/javascript"})),r=new Worker(s),i=new f.Cr;this.db=new f.Ed(i,r),await this.db.instantiate(t.mainModule,t.pthreadWorker),URL.revokeObjectURL(s),this.connection=await this.db.connect()};close=async()=>{this.connection&&(await this.connection.close(),this.connection=null),this.db&&(await this.db.terminate(),this.db=null)};writeFile=async(e,t)=>{let a;if(!this.db)throw Error("db is null");if(t instanceof Blob)a=new Uint8Array(await t.arrayBuffer());else throw Error("Unsupported source type");await this.db.registerFileBuffer(e,a)};query=async e=>{if(!this.connection)throw Error("connection is null");let t=await this.connection.query(e);return{dataset:t.toArray().map(e=>e.toJSON()),table:t}};getSchema=async e=>{if(!this.connection)throw Error("connection is null");return(await this.connection.query(`PRAGMA table_info('${e}')`)).toArray().map(e=>e.toJSON())}}class w{queryAdapter;storageAdapter;_datasetId;constructor(e,t,a){this.queryAdapter=e,this.storageAdapter=t,this._datasetId=a}async init(e,t){let a=await this.storageAdapter.readDataset(this._datasetId);if(!a)throw Error(`Dataset ${this._datasetId} not found`);let s=e||a.datasetSchema.columns,r=t||a.datasetSource;s.length>0&&r&&await this.createOrReplaceView(s,r)}async createOrReplaceView(e,t){let a={number:"DOUBLE",string:"VARCHAR",date:"DATE",datetime:"TIMESTAMP",timestamp:"TIMESTAMP"};if(t){let s={csv:"read_csv_auto",json:"read_json_auto",xlsx:"read_excel",parquet:"read_parquet"}[t.type];if(!s)throw Error(`Unsupported dataSource type: ${t.type}`);await this.queryAdapter.writeFile(this._datasetId,t.blob);let r=`{${e.map(e=>`'${e.name}': '${a[e.type]||"VARCHAR"}'`).join(", ")}}`,i=e.map(e=>`"${e.name}"`).join(", "),n=`CREATE OR REPLACE VIEW "${this._datasetId}" AS SELECT ${i} FROM ${s}('${this._datasetId}', columns=${r})`;await this.queryAdapter.query(n)}}async query(e){let t=d(e,this.datasetId);return this.queryBySQL(t)}async queryBySQL(e){let t=performance?.now?.()?.toFixed(3)??Date.now().toFixed(3),a=await this.queryAdapter.query(e),s=performance?.now?.()?.toFixed(3)??Date.now().toFixed(3);return{...a,performance:{startAt:t,endAt:s,duration:Number(s)-Number(t)}}}async disconnect(){await this.queryAdapter.query(`DROP VIEW IF EXISTS "${this._datasetId}"`)}get datasetId(){return this._datasetId}}class b{queryAdapter;storageAdapter;isInitialized=!1;constructor(){this.queryAdapter=new g,this.storageAdapter=new y}async checkInitialized(){this.isInitialized||(await this.queryAdapter.open(),await this.storageAdapter.open(),this.isInitialized=!0)}async checkDatasetExists(e){if(!await this.hasDataset(e))throw Error(`dataset ${e} not exists, please create it first`)}async createDataset(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2?arguments[2]:void 0;await this.checkInitialized();let s=a?await m.from(a).build():void 0;if(await this.hasDataset(e))throw Error(`dataset ${e} already exists`);await this.storageAdapter.writeDataset(e,{datasetId:e,datasetAlias:e,columns:t},s)}async updateDatasetSource(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2?arguments[2]:void 0;await this.checkInitialized(),await this.checkDatasetExists(e);let s=a?await m.from(a).build():void 0;await this.storageAdapter.writeDataset(e,{datasetId:e,datasetAlias:e,columns:t},s)}async dropDataset(e){await this.checkInitialized(),await this.checkDatasetExists(e),await this.storageAdapter.deleteDataset(e)}async connectDataset(e,t,a){await this.checkInitialized(),await this.checkDatasetExists(e);let s=new w(this.queryAdapter,this.storageAdapter,e),r=a?await m.from(a).build():void 0;return await s.init(t,r),s}async hasDataset(e){return await this.checkInitialized(),(await this.storageAdapter.listDatasets()).some(t=>t.datasetId===e)}async listDatasets(){return await this.checkInitialized(),this.storageAdapter.listDatasets()}async close(){await this.checkInitialized(),await this.queryAdapter.close(),await this.storageAdapter.close()}}}}]);
//# sourceMappingURL=2453.03b00e56.js.map