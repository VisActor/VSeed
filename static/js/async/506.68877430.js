"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["506"],{18152:function(e,t,s){s.r(t),s.d(t,{VBIBuilder:()=>w,preorderTraverse:()=>v.C,VBI:()=>b,ChartTypeBuilder:()=>y,DimensionsBuilder:()=>n,quickInsight:()=>S,buildVQuery:()=>c,findTreeNodesBy:()=>v.r,MeasuresBuilder:()=>l});var a=s(72513),i=s(24464);class r{setAlias(e){return this.yMap.set("alias",e),this}build(){return this.yMap.toJSON()}constructor(e){(0,a._)(this,"yMap",void 0),this.yMap=e}}class n{addDimension(e,t){let s={};"string"==typeof e?(s.alias=e,s.field=e):(s.alias=e.alias,s.field=e.field||e.alias);let a=new i.Map;for(let[e,t]of Object.entries(s))a.set(e,t);this.dsl.get("dimensions").push([a]);let n=new r(a);return t?(t(n),this):n}removeDimension(e){let t=this.dsl.get("dimensions").toArray().findIndex(t=>t.get("field")===e);-1!==t&&this.dsl.get("dimensions").delete(t,1)}getDimensions(){return this.dsl.get("dimensions").toJSON()}observe(e){this.dsl.get("dimensions").observe(e)}unobserve(e){this.dsl.get("dimensions").unobserve(e)}static isDimensionNode(e){return"alias"in e&&!("children"in e)}static isDimensionGroup(e){return"children"in e}constructor(e,t){(0,a._)(this,"dsl",void 0),(0,a._)(this,"doc",void 0),this.doc=e,this.dsl=t}}class o{setAlias(e){return this.yMap.set("alias",e),this}setEncoding(e){return this.yMap.set("encoding",e),this}setAggregate(e){return this.yMap.set("aggregate",e),this}build(){return this.yMap.toJSON()}constructor(e){(0,a._)(this,"yMap",void 0),this.yMap=e}}class l{addMeasure(e,t){let s={};"string"==typeof e?(s.alias=e,s.field=e,s.encoding="yAxis",s.aggregate={func:"sum"}):(s.alias=e.alias,s.field=e.field,s.encoding=e.encoding,s.aggregate=e.aggregate);let a=new i.Map;for(let[e,t]of Object.entries(s))a.set(e,t);this.dsl.get("measures").push([a]);let r=new o(a);return t?(t(r),this):r}removeMeasure(e){let t=this.dsl.get("measures").toArray().findIndex(t=>t.get("field")===e);-1!==t&&this.dsl.get("measures").delete(t,1)}getMeasures(){return this.dsl.get("measures").toJSON()}observe(e){this.dsl.get("measures").observe(e)}unobserve(e){this.dsl.get("measures").unobserve(e)}static isMeasureNode(e){return"field"in e}static isMeasureGroup(e){return"children"in e}constructor(e,t){(0,a._)(this,"dsl",void 0),(0,a._)(this,"doc",void 0),this.doc=e,this.dsl=t}}var d=s(83671);let c=(e,t)=>{let s=s=>a=>s(a,{vbiDSL:e,builder:t});return(0,d.a)({},s(h),s(u),s(p))},h=(e,t)=>{let{vbiDSL:s}=t,a=s.measures,i=s.dimensions,r={...e},o=a.filter(e=>l.isMeasureNode(e)).map(e=>({field:e.field,alias:e.alias,func:e.aggregate.func})),d=i.filter(e=>n.isDimensionNode(e)).map(e=>({field:e.field,alias:e.alias}));return r.select=o.concat(d),r},u=(e,t)=>{let s={...e},{vbiDSL:a}=t;return s.groupBy=a.dimensions.filter(e=>n.isDimensionNode(e)).map(e=>e.field),s},p=e=>{let t={...e};return t.limit=1e3,t};var m=s(62999);class y{observe(e){this.dsl.observe((t,s)=>{t.keysChanged.has("chartType")&&e(t,s)})}unobserve(e){this.dsl.unobserve((t,s)=>{t.keysChanged.has("chartType")&&e(t,s)})}changeChartType(e){this.dsl.set("chartType",e)}getChartType(){return this.dsl.get("chartType")||"table"}getAvailableChartTypes(){return[m.oV.Table,m.oV.PivotTable,m.oV.Line,m.oV.Column,m.oV.ColumnPercent,m.oV.ColumnParallel,m.oV.BarPercent,m.oV.BarParallel,m.oV.Area,m.oV.AreaPercent,m.oV.DualAxis,m.oV.Scatter,m.oV.Rose,m.oV.RoseParallel,m.oV.Pie,m.oV.Donut,m.oV.Radar,m.oV.Funnel,m.oV.Heatmap,m.oV.Boxplot,m.oV.Histogram]}constructor(e,t){(0,a._)(this,"dsl",void 0),this.dsl=t}}let f=new Map,g=async e=>{let t=f.get(e);if(!t)throw Error(`connector ${e} not registered`);return"function"==typeof t?t():t};class w{applyUpdate(e){i.applyUpdate(this.doc,e)}encodeStateAsUpdate(e){return i.encodeStateAsUpdate(this.doc,e)}constructor(e){(0,a._)(this,"doc",void 0),(0,a._)(this,"dsl",void 0),(0,a._)(this,"undoManager",void 0),(0,a._)(this,"chartType",void 0),(0,a._)(this,"measures",void 0),(0,a._)(this,"dimensions",void 0),(0,a._)(this,"buildVSeed",async()=>{let e=this.build(),t=e.connectorId,s=await g(e.connectorId),a=this.buildVQuery(),i=await s.discoverSchema(),r=await s.query({queryDSL:a,schema:i,connectorId:t});return{chartType:e.chartType,dataset:r.dataset}}),(0,a._)(this,"buildVQuery",()=>c(this.build(),this)),(0,a._)(this,"build",()=>this.dsl.toJSON()),(0,a._)(this,"getSchema",async()=>{let e=this.dsl.get("connectorId"),t=await g(e);return await t.discoverSchema()}),this.doc=e,this.dsl=e.getMap("dsl"),this.undoManager=new i.UndoManager(this.dsl),this.chartType=new y(e,this.dsl),this.measures=new l(e,this.dsl),this.dimensions=new n(e,this.dsl)}}let b={connectorMap:f,registerConnector:(e,t)=>{f.set(e,t)},getConnector:g,generateEmptyDSL:e=>({connectorId:e,chartType:"table",measures:[],dimensions:[],theme:"light",locale:"zh-CN",version:0}),from:e=>{let t=new i.Doc,s=t.getMap("dsl");return t.transact(()=>{e.connectorId&&s.set("connectorId",e.connectorId),e.chartType&&s.set("chartType",e.chartType),e.theme&&s.set("theme",e.theme),e.locale&&s.set("locale",e.locale),e.version&&s.set("version",e.version),s.get("measures")?s.set("measures",e.measures):s.set("measures",new i.Array),s.get("dimensions")?s.set("dimensions",e.dimensions):s.set("dimensions",new i.Array)}),new w(t)}};var v=s(22120),A=s(23135);let _={zScoreMad:(e,t)=>{if("zScoreMad"!==t.insightType)return{dataset:e,insightInfo:[]};let{measures:s,threshold:a=2.5}=t,i={};for(let t of s){let s=e.map(e=>e[t]).filter(e=>"number"==typeof e&&Number.isFinite(e)),a=s.length?(0,A.C2)(s):0,r=s.length?(0,A.Ju)(s):0;i[t]={median:a,mad:r}}return{dataset:e.map(e=>{let t={...e};for(let r of s){let s=e[r],n=`${r}_score`,o=`${r}_isAnomaly`,l=0;if("number"==typeof s&&Number.isFinite(s)){let e=i[r].median,t=i[r].mad;l=0===t?0:.6745*(s-e)/t}t[n]=l,t[o]=Math.abs(l)>=a}return t}),insightInfo:s.map(e=>{var t,s;return{field:e,scoreField:`${e}_score`,isAnomalyField:`${e}_isAnomaly`,algorithm:"zScoreMad",params:{threshold:a,median:(null==(t=i[e])?void 0:t.median)??0,mad:(null==(s=i[e])?void 0:s.mad)??0}}})}},zScoreRolling:(e,t)=>{if("zScoreRolling"!==t.insightType)return{dataset:e,insightInfo:[]};let{valueField:s,window:a,outputField:i,timeField:r,threshold:n}=t.schema,o=i??s;return{dataset:e.map((t,i)=>{let r={...t},l=[],d=Math.max(0,i-a);for(let t=d;t<i;t++){let a=e[t][s];"number"==typeof a&&Number.isFinite(a)&&l.push(a)}let c=t[s],h=0;if("number"==typeof c&&Number.isFinite(c)&&l.length>=2){let e=(0,A.J6)(l),t=(0,A.IN)(l);h=0===t?0:(c-e)/t}return r[`${o}_score`]=h,r[`${o}_isAnomaly`]=Math.abs(h)>=n,r}),insightInfo:[{field:o,scoreField:`${o}_score`,isAnomalyField:`${o}_isAnomaly`,algorithm:"zScoreRolling",params:{window:a,threshold:n,valueField:s,outputField:o,timeField:r??null}}]}}};function S(e,t){let s=_[t.insightType];return s?s(e,t):{dataset:e,insightInfo:[]}}},81723:function(e,t,s){s.r(t),s.d(t,{isBase64Url:()=>b,isHttpUrl:()=>w,VQuery:()=>D,DatasetSourceBuilder:()=>v,isUrl:()=>g,convertDSLToSQL:()=>y});var a=s(90375),i=s(67771),r=s(76533),n=s(9572);class o{createDriver(){return new i.U}createQueryCompiler(){return new r.n}createAdapter(){return new n.r}createIntrospector(e){return new class{async getSchemas(){return[]}async getTables(e){return null==e||e.withInternalKyselyTables,[]}async getMetadata(e){return null==e||e.withInternalKyselyTables,{tables:[]}}}}}let l=e=>"object"==typeof e&&"field"in e,d=e=>null===e?"null":"string"==typeof e?`'${e.replace(/'/g,"''")}'`:"number"==typeof e?`${e}`:"boolean"==typeof e?e?"TRUE":"FALSE":`'${String(e).replace(/'/g,"''")}'`,c=(e,t)=>{if(0===t.length)return e;if(e.includes("?")){let s=e;for(let e of t)s=s.replace(/\?/,d(e));return s}return/\$\d+/.test(e)?e.replace(/\$(\d+)/g,(e,s)=>d(t[Number(s)-1])):e};var h=s(11593);let u=e=>{let t=e=>{if("op"in e&&"conditions"in e){let s=e.conditions.map(e=>t(e)),a=(0,h.i)` ${h.i.raw(e.op)} `;return(0,h.i)`(${h.i.join(s,a)})`}let s=e.field,a=e.value;switch(e.op){case"is null":return(0,h.i)`${h.i.ref(s)} is null`;case"is not null":return(0,h.i)`${h.i.ref(s)} is not null`;case"in":{let e=Array.isArray(a)?a:[a];return(0,h.i)`${h.i.ref(s)} in (${h.i.join(e.map(e=>h.i.val(e)))})`}case"not in":{let e=Array.isArray(a)?a:[a];return(0,h.i)`not ${h.i.ref(s)} in (${h.i.join(e.map(e=>h.i.val(e)))})`}case"between":{let[e,t]=a;return(0,h.i)`${h.i.ref(s)} between (${h.i.val(e)}, ${h.i.val(t)})`}case"not between":{let[e,t]=a;return(0,h.i)`not ${h.i.ref(s)} between (${h.i.val(e)}, ${h.i.val(t)})`}default:return(0,h.i)`${h.i.ref(s)} ${h.i.raw(e.op)} ${h.i.val(a)}`}};return t(e)},p=(e,t)=>{if(t&&t.length>0){let s=t.map(e=>h.i.id(e));e=e.groupBy(s)}return e},m=(e,t)=>(t&&"number"==typeof t&&(e=e.limit(t)),e),y=(e,t)=>{let s=new a.$2({dialect:new o}).selectFrom(t);if(s=e.select&&e.select.length>0?s.select(t=>e.select.map(e=>{if(l(e)){let s=e.field;if(e.func){let a=e.alias??s;switch(e.func){case"avg":return t.fn.avg(s).as(a);case"sum":return t.fn.sum(s).as(a);case"min":return t.fn.min(s).as(a);case"max":return t.fn.max(s).as(a);case"count":return t.fn.count(s).as(a)}}return e.alias?t.ref(s).as(e.alias):s}return e})):s.selectAll(),e.where&&(s=s.where(u(e.where))),s=p(s,e.groupBy),e.orderBy&&e.orderBy.length>0)for(let t of e.orderBy)s=s.orderBy(t.field,t.order??"asc");let i=(s=m(s,e.limit)).compile();return c(i.sql,i.parameters)};var f=s(72513);let g=e=>w(e)||b(e),w=e=>e.startsWith("http://")||e.startsWith("https://"),b=e=>e.startsWith("data:");class v{static from(e){return new v(e)}async build(){let e=await v.convertToBlob(this.type,this.value);return{type:this.type,blob:e}}static async convertToBlob(e,t){if(t instanceof Blob)return t;switch(e){case"csv":return t instanceof ArrayBuffer?new Blob([t],{type:"text/csv"}):"string"==typeof t&&g(t)?v.fetchBlob(t):new Blob([JSON.stringify(t)],{type:"text/csv"});case"json":return t instanceof ArrayBuffer?new Blob([t],{type:"application/json"}):"string"==typeof t&&g(t)?v.fetchBlob(t):new Blob([JSON.stringify(t)],{type:"application/json"});case"xlsx":return t instanceof ArrayBuffer?new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}):"string"==typeof t&&g(t)?v.fetchBlob(t):new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});case"parquet":return t instanceof ArrayBuffer?new Blob([t],{type:"application/parquet"}):"string"==typeof t&&g(t)?v.fetchBlob(t):new Blob([t],{type:"application/parquet"});default:return new Blob([t])}}static async fetchBlob(e){let t=await fetch(e);return await t.blob()}constructor(e){(0,f._)(this,"type",void 0),(0,f._)(this,"value",void 0),this.type=e.type,this.value=e.rawDataset}}class A{constructor(e="vquery"){(0,f._)(this,"db",null),(0,f._)(this,"dbName",void 0),(0,f._)(this,"datasetStoreName","vqueryDatasets"),(0,f._)(this,"open",()=>new Promise((e,t)=>{let s=indexedDB.open(this.dbName,2);s.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(this.datasetStoreName)||t.createObjectStore(this.datasetStoreName,{keyPath:"datasetId"})},s.onsuccess=t=>{this.db=t.target.result,e()},s.onerror=e=>{t(e.target.error)}})),(0,f._)(this,"close",async()=>{this.db&&(this.db.close(),this.db=null)}),(0,f._)(this,"writeDataset",(e,t,s)=>new Promise((a,i)=>{if(!this.db)return i("DB is not open");let r=this.db.transaction([this.datasetStoreName],"readwrite").objectStore(this.datasetStoreName).put({datasetId:e,datasetSchema:t,datasetSource:s});r.onsuccess=()=>{a()},r.onerror=e=>{i(e.target.error)}})),(0,f._)(this,"readDataset",e=>new Promise((t,s)=>{if(!this.db)return s("DB is not open");let a=this.db.transaction([this.datasetStoreName],"readonly").objectStore(this.datasetStoreName).get(e);a.onsuccess=e=>{t(e.target.result||null)},a.onerror=e=>{s(e.target.error)}})),(0,f._)(this,"deleteDataset",e=>new Promise((t,s)=>{if(!this.db)return s("DB is not open");let a=this.db.transaction([this.datasetStoreName],"readwrite").objectStore(this.datasetStoreName).delete(e);a.onsuccess=()=>{t()},a.onerror=e=>{s(e.target.error)}})),(0,f._)(this,"listDatasets",()=>new Promise((e,t)=>{if(!this.db)return t("DB is not open");let s=this.db.transaction([this.datasetStoreName],"readonly").objectStore(this.datasetStoreName).getAll();s.onsuccess=t=>{e(t.target.result)},s.onerror=e=>{t(e.target.error)}})),this.dbName=e}}var _=s(2371);class S{constructor(){(0,f._)(this,"db",null),(0,f._)(this,"connection",null),(0,f._)(this,"open",async()=>{let e={mvp:{mainModule:new URL(s(80681),s.b).href,mainWorker:new URL(s(85434),s.b).toString()},eh:{mainModule:new URL(s(59108),s.b).href,mainWorker:new URL(s(70491),s.b).toString()}},t=await (0,_.Dn)(e),a=URL.createObjectURL(new Blob([`importScripts("${t.mainWorker}");`],{type:"text/javascript"})),i=new Worker(a),r=new _.kw;this.db=new _.ak(r,i),await this.db.instantiate(t.mainModule,t.pthreadWorker),URL.revokeObjectURL(a),this.connection=await this.db.connect()}),(0,f._)(this,"close",async()=>{this.connection&&(await this.connection.close(),this.connection=null),this.db&&(await this.db.terminate(),this.db=null)}),(0,f._)(this,"writeFile",async(e,t)=>{let s;if(!this.db)throw Error("db is null");if(t instanceof Blob)s=new Uint8Array(await t.arrayBuffer());else throw Error("Unsupported source type");await this.db.registerFileBuffer(e,s)}),(0,f._)(this,"query",async e=>{if(!this.connection)throw Error("connection is null");let t=await this.connection.query(e);return{dataset:t.toArray().map(e=>e.toJSON()),table:t}}),(0,f._)(this,"getSchema",async e=>{if(!this.connection)throw Error("connection is null");return(await this.connection.query(`PRAGMA table_info('${e}')`)).toArray().map(e=>e.toJSON())})}}class B{async init(e,t){let s=await this.storageAdapter.readDataset(this._datasetId);if(!s)throw Error(`Dataset ${this._datasetId} not found`);let a=e||s.datasetSchema.columns,i=t||s.datasetSource;a.length>0&&i&&await this.createOrReplaceView(a,i)}async createOrReplaceView(e,t){let s={number:"DOUBLE",string:"VARCHAR",date:"DATE",datetime:"TIMESTAMP",timestamp:"TIMESTAMP"};if(t){let a={csv:"read_csv_auto",json:"read_json_auto",xlsx:"read_excel",parquet:"read_parquet"}[t.type];if(!a)throw Error(`Unsupported dataSource type: ${t.type}`);await this.queryAdapter.writeFile(this._datasetId,t.blob);let i=`{${e.map(e=>`'${e.name}': '${s[e.type]||"VARCHAR"}'`).join(", ")}}`,r=e.map(e=>`"${e.name}"`).join(", "),n=`CREATE OR REPLACE VIEW "${this._datasetId}" AS SELECT ${r} FROM ${a}('${this._datasetId}', columns=${i})`;await this.queryAdapter.query(n)}}async query(e){let t=y(e,this.datasetId);return this.queryBySQL(t)}async queryBySQL(e){var t,s,a,i,r,n;let o=(null==(a=performance)||null==(s=a.now)||null==(t=s.call(a))?void 0:t.toFixed(3))??Date.now().toFixed(3),l=await this.queryAdapter.query(e),d=(null==(n=performance)||null==(r=n.now)||null==(i=r.call(n))?void 0:i.toFixed(3))??Date.now().toFixed(3);return{...l,performance:{startAt:o,endAt:d,duration:Number(d)-Number(o)}}}async disconnect(){await this.queryAdapter.query(`DROP VIEW IF EXISTS "${this._datasetId}"`)}get datasetId(){return this._datasetId}constructor(e,t,s){(0,f._)(this,"queryAdapter",void 0),(0,f._)(this,"storageAdapter",void 0),(0,f._)(this,"_datasetId",void 0),this.queryAdapter=e,this.storageAdapter=t,this._datasetId=s}}class D{async checkInitialized(){this.isInitialized||(await this.queryAdapter.open(),await this.storageAdapter.open(),this.isInitialized=!0)}async checkDatasetExists(e){if(!await this.hasDataset(e))throw Error(`dataset ${e} not exists, please create it first`)}async createDataset(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],s=arguments.length>2?arguments[2]:void 0;await this.checkInitialized();let a=s?await v.from(s).build():void 0;if(await this.hasDataset(e))throw Error(`dataset ${e} already exists`);await this.storageAdapter.writeDataset(e,{datasetId:e,datasetAlias:e,columns:t},a)}async updateDatasetSource(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],s=arguments.length>2?arguments[2]:void 0;await this.checkInitialized(),await this.checkDatasetExists(e);let a=s?await v.from(s).build():void 0;await this.storageAdapter.writeDataset(e,{datasetId:e,datasetAlias:e,columns:t},a)}async dropDataset(e){await this.checkInitialized(),await this.checkDatasetExists(e),await this.storageAdapter.deleteDataset(e)}async connectDataset(e,t,s){await this.checkInitialized(),await this.checkDatasetExists(e);let a=new B(this.queryAdapter,this.storageAdapter,e),i=s?await v.from(s).build():void 0;return await a.init(t,i),a}async hasDataset(e){return await this.checkInitialized(),(await this.storageAdapter.listDatasets()).some(t=>t.datasetId===e)}async listDatasets(){return await this.checkInitialized(),this.storageAdapter.listDatasets()}async close(){await this.checkInitialized(),await this.queryAdapter.close(),await this.storageAdapter.close()}constructor(){(0,f._)(this,"queryAdapter",void 0),(0,f._)(this,"storageAdapter",void 0),(0,f._)(this,"isInitialized",!1),this.queryAdapter=new S,this.storageAdapter=new A}}}}]);
//# sourceMappingURL=506.68877430.js.map